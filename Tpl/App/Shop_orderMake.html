<!doctype html>
<html>
<head>
    <title>订单确认</title>
    <meta charset="utf-8" />
		<!--页面优化-->
		<meta name="MobileOptimized" content="320">
		<!--默认宽度320-->
		<meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
		<!--viewport 等比 不缩放-->
		<meta http-equiv="cleartype" content="on">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<!--删除苹果菜单-->
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
		<!--默认颜色-->
		<meta name="apple-mobile-web-app-title" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<!--加载全部后 显示-->
		<meta content="telephone=no" name="format-detection" />
		<!--不识别电话-->
		<meta content="email=no" name="format-detection" />
		<link rel="stylesheet" href="__PUBLIC__/App/css/style.css" />
	    <!--组件依赖js begin-->
	    <script src="__PUBLIC__/App/js/zepto.min.js"></script>
	    <!--组件依赖js end-->		
		<script type="text/javascript" src="__PUBLIC__/App/gmu/gmu.min.js"></script>
        <script type="text/javascript" src="__PUBLIC__/App/gmu/app-basegmu.js"></script>
    

</head>
<body class="back1 color6">
		<form action="" method="post" id="orderform">
		<!-- 地址  -->
		<div class="ads-hd border-b1 back2 ovflw mr-b">
			<div class="ads-line"></div>
			<a href="#" class="ads-chs" id="changeaddress">
				<empty name="vip">
					请选择收货地址<i class="iconfont fr">&#xe6a3</i>
					<else/>
					收货人：{$vip.name}&nbsp;&nbsp;&nbsp;{$vip.mobile}<i class="iconfont fr">&#xe6a3</i>
					<p class="fonts9">收货地址：{$vip.address}</p>
				</empty>
			</a>
			<input type="hidden" name="sid" value="{$sid}">
			<input type="hidden" name="paytype" value="" id="paytype">
			<input type="hidden" name="vipid" value="{$vip.vipid}" id="ordervip">
			<input type="hidden" name="vipopenid" value="{$_SESSION['WAP']['vip']['openid']}">
			<input type="hidden" name="vipname" value="{$vip.name}">
			<input type="hidden" name="vipaddress" value="{$vip.address}">
			<input type="hidden" name="vipmobile" value="{$vip.mobile}">
			<!--<input type="hidden" name="vipxqid" value="{$vip.xqid}">
			<input type="hidden" name="vipxqname" value="{$vip.xqname}">-->
			<input type="hidden" name="totalnum" value="{$totalnum}">
			<input type="hidden" name="totalprice" value="{$totalprice}">
			<textarea name="items" style="display: none;">{$allitems}</textarea>
			<input type="hidden" name="isyf" value="{$isyf}">
			<input type="hidden" name="bdgoodsid" value="">
			<input type="hidden" name="bdgoodsprice" value="">
			<input type="hidden" id = "ishavebd" name="ishavebd" value="{$ishavebd}">
			<input type="hidden" id = "ishavepj" name="ishavepj" value="{$ishavepj}">
		</div>
		<!-- 商品明细  -->
		<div class="ads-lst border-t1 border-b1 ovflw mr-b back2">
			<p class="ads-tt border-b1">商品明细</p>
			<foreach name="cache" item="vo">
				<div class="ads_orinfo ads_padding3 ovflw border-b1">
					<div class="ads_orinfol ovflw fl">
						<div class="ads_or_img fl">
							<!-- 图片大小为147*101 -->
							<img src="{$vo.pic}"/>
						</div>
						<h3>{$vo.name}</h3>
						<p class="color3 fonts2">{$vo.skuattr}</p>
					</div>
					<div class="ads_orprice ovflw ">
						<p ><em class="fonts85">￥</em><em class="fonts18">{$vo.price}</em></p>
						<p class="ads_ornum fonts85">X{$vo.num}</p>
					</div>
				</div>
			</foreach>
			<p class="border-b1 ads_ortt3 fonts18 color3">&nbsp;使用代金卷<span class="fr"><select name="djqid" id="djqid" class="ads-sel"><option value="0" data-money="0">请选择有效代金卷</option><foreach name="djq" item="vo"><option value="{$vo.id}" data-money="{$vo.money}">{$vo.money}元代金卷</option></foreach></select></span></p>
			<gt name="vipInfo.cashq" value="0"><p class="border-b1 ads_ortt3 fonts85">&nbsp;现金券共<em class="fonts18 color3"><b>{$vipInfo.cashq}</b></em>元,本次使用 <input style="width: 50px;color: red;font-size: 18px;text-align: center"  type="text" name="cashq" id="cashq" value="0"> 元</p></gt>
			<eq name="ishavepj" value="1"><eq name="ishavebd" value="0"><gt name="vipInfo.gwqmoney" value="0"><p class="border-b1 ads_ortt3 fonts85">&nbsp;购物券共<em class="fonts18 color3"><b>{$vipInfo.gwqmoney}</b></em>元,最大可用<em class="fonts18 color3"><b>{$maxgwq}</b></em>元,本次使用 <input style="width: 50px;color: red;font-size: 18px;text-align: center"  type="text" name="gwq" id="gwq" value="0"> 元</p></gt></eq></eq>
			<eq name="ishavepj" value="0"><eq name="ishavebd" value="1"><eq name="vipInfo.isfx" value="1"><else/><p class="border-b1 ads_ortt3 fonts18">&nbsp;金果数量：<em class="fonts18 color3"><b class="totalapple">{$vipInfo.score}</b></em><span class="fr"><select name="jgid" id="jgid" class="ads-sel"><option value="0" data-money="0">选择金果数量</option><egt name="vipInfo.score" value="87"><option value="87" data-money="87">87个金果</option></egt></select></span> </p></eq></eq></eq>
			<eq name="ishavepj" value="0"><eq name="ishavebd" value="1"><gt name="vipInfo.levelprice" value="0"><lt name="vipInfo.levelprice" value="$maxprice"><p class="border-b1 ads_ortt3 fonts18">&nbsp;此商品可升级会员级别,免支付<em class="fonts18 color3"><b class="mf">￥{$vipInfo.levelprice}</b><input type="hidden" id="mf" name="mf" value="{$vipInfo.levelprice}"/></em></p></lt></gt></eq></eq>
			<p class="border-b1 ads_ortt3 fonts85">&nbsp;邮费政策：<eq name="isyf" value="1">全场定邮{$yf}元，订单满{$yftop}元包邮。<else/>全场包邮</eq></p>
			<p class="border-b1 ads_ortt3 fonts85 ads"><input type="text" name="msg" class="ads_orinput" placeholder="给卖家留言"/></p>
			<p class=" ads_ortt3 fonts85 ovflw"><span class="fr ">共{$totalnum}件商品&nbsp;&nbsp;&nbsp;&nbsp;商品：<em class="fonts18 color3">￥<b class="totalprice">{$totalprice}</b></em>&nbsp;&nbsp;&nbsp;&nbsp;邮费：<em class="fonts18 color3">￥<b>{$yf}</b></em></span></p>
		</div>
		</form>
		<!-- 支付方式 -->
		<div class="ads-lst border-t1 border-b1 ovflw mr-b back2">
			<p class="ads-tt border-b1">支付方式</p>
					<div class="ads_pay ovflw ads_border_dashed" data-paytype = "money" data-disable="{$isyue}">
						<span class="iconfont fl ads_pay_lineh dtl_mar1">&#xe6d4</span>
						<div class="ads_orimg fl dtl_mar1">
							<img src="__PUBLIC__/App/img/tue.jpg" />
						</div>
						<p class="ads_pay_p1 ads_pay_lineh1">余额：<i id='money' data-money='{$_SESSION['WAP']['vip']['money']}'>￥{$_SESSION['WAP']['vip']['money']}</i></p>
						<p class="ads_pay_p2 ads_pay_lineh1 color10 ads_font_size2">余额不足由其他方式支付</p>
					</div>
					<!--
					<div class="ads_pay ovflw" data-paytype = "alipayApp" data-disable="0">
						<span class="iconfont fl ads_pay_lineh dtl_mar1">&#xe656</span>
						<div class="ads_orimg fl dtl_mar1">
							<img src="__PUBLIC__/App/img/zhif.jpg" />
						</div>
						<p class="ads_pay_lineh">手机支付宝支付</p>
					</div>
					-->
					<div class="ads_pay ovflw" data-paytype = "wxpay" data-disable="0">
						<span class="iconfont fl ads_pay_lineh dtl_mar1">&#xe656</span>
						<div class="ads_orimg fl dtl_mar1">
							<img src="__PUBLIC__/App/img/wxpay.jpg" />
						</div>
						<p class="ads_pay_lineh">微信安全支付</p>
					</div>
					<!-- 银联支付备用 -->
					<!--<div class="ads_pay ovflw " data-paytype = "yinlian">
						<span class="iconfont fl ads_pay_lineh dtl_mar1">&#xe656</span>
						<div class="ads_orimg fl dtl_mar1">
							<img src="__PUBLIC__/App/img/yl.jpg" />
						</div>
						<p class="ads_pay_lineh">银联支付</p>
					</div>-->
		</div>
		<div class="insert1"></div>
		<div class="dtl-ft ovflw">
				<div class=" fl dtl-icon dtl-bck ovflw">
					<a href="{$basketurl}">
						<i class="iconfont">&#xe679</i>
					</a>
				</div>
				<a href="#" class="fr ads-btn fonts9 back3" id="orderconfirm">确认</a>
				<span class="fr ads-sum"><em class="fonts9">商品:</em><em class="fonts1">￥<b class="totalprice">{$totalprice}</b></em>&nbsp;&nbsp;&nbsp;&nbsp;邮费:<em class="fonts18 color3">￥<b>{$yf}</b></em></span>
		</div>
		<script type="text/javascript">
			//如果是升级会员级别则减免对应金额
            var nowtotal = "{$totalprice}";
            var currentmoney ="{$totalprice}";
            var mf = 0;
            var gwq = 0;
            var cashq = 0;
            var apple = 0;
            var djq = 0;
			$(function () {
                if($('#mf').val()!=undefined)
				{
                    var newmoney = Number(nowtotal)-Number($('#mf').val()) - mf - gwq - cashq - apple - djq;
                    mf = Number($('#mf').val());
                    $(totalprice).html(newmoney);
				}
            })

			var sid="{$sid}";
			var lasturlencode="{$lasturlencode}";
			var paytype=$('#paytype');
			$('#changeaddress').on('click',function(){
				var tourl="{:U('App/Shop/orderAddress',array('sid'=>$sid,'lasturl'=>$lasturlencode))}";
				window.location.href=tourl;
			});
			$('.ads_pay').click(function(){
				var isdis=$(this).data('disable');
				if(isdis==0){
					var sp=$('.ads_pay span');
					$(sp).css('color',' #cfcfcf');
					$(this).find('span').css('color',' #ff3000');
					$(paytype).val($(this).data('paytype'));
				}else{
					App_gmuMsg('请使用其它方式！');
				}
			});
            $('#cashq').on('change',function () {
                var maxcashq = "{$vipInfo.cashq}";

                if(Number($('#cashq').val()) > maxcashq || Number($('#cashq').val()) < 0)
                {
                    App_gmuMsg('现金券本次最大可使用'+maxcashq+'元！');
                    $('#cashq').val(0);
                    var newmoney=Number(nowtotal)-Number($('#cashq').val())- mf - gwq - apple - djq;
                    $(totalprice).html(newmoney);
                    return false;
                }else
                {
                    //现金券特效
                    var newmoney=Number(nowtotal)-Number($('#cashq').val()) - mf - gwq - apple - djq;
                    cashq = Number($('#cashq').val());
                    // 初始支付限制
                    $('.ads_pay').data('disable',0);
                    $('.ads_pay span').css('color',' #cfcfcf');
                    // 判断当前的是否小于0，小于0设置为0
                    if(newmoney<=0){
                        newmoney=0;
                        $('.ads_pay').each(function(){
                            // 允许只允许使用余额支付
                            if($(this).data('paytype')=='wxpay'){
                                $(this).data('disable',1);
                            }
                        });
                    }
                    // 判断可否使用余额支付
                    var money = Number($('#money').data('money'));
                    if(newmoney>money){
                        $('.ads_pay').each(function(){
                            if($(this).data('paytype')=='money'){
                                $(this).data('disable',1);
                            }
                        });
                    }
                    $(totalprice).html(newmoney);
                }
            });
			$('#gwq').on('change',function () {
			    var maxgwq = "{$maxgwq}";
				if(Number($('#gwq').val()) > maxgwq || Number($('#gwq').val()) < 0)
				{
                    App_gmuMsg('购物券本次最大可使用'+maxgwq+'元！');
                    $('#gwq').val(0);
                    var newmoney=Number(nowtotal)-Number($('#gwq').val())- mf - cashq - apple - djq;
                    $(totalprice).html(newmoney);
                    return false;
				}else
				{
					//购物券特效
                    var newmoney=Number(nowtotal)-Number($('#gwq').val()) - mf - cashq - apple - djq;
                    gwq = Number($('#gwq').val());
                    // 初始支付限制
                    $('.ads_pay').data('disable',0);
                    $('.ads_pay span').css('color',' #cfcfcf');
                    // 判断当前的是否小于0，小于0设置为0
                    if(newmoney<=0){
                        newmoney=0;
                        $('.ads_pay').each(function(){
                            // 允许只允许使用余额支付
                            if($(this).data('paytype')=='wxpay'){
                                $(this).data('disable',1);
                            }
                        });
                    }
                    // 判断可否使用余额支付
                    var money = Number($('#money').data('money'));
                    if(newmoney>money){
                        $('.ads_pay').each(function(){
                            if($(this).data('paytype')=='money'){
                                $(this).data('disable',1);
                            }
                        });
                    }
                    $(totalprice).html(newmoney);
                }
            });
			$('#orderconfirm').on('click',function(){
				if(!$('#ordervip').val()){
					App_gmuMsg('请选择收货地址！');
					return false;
				}
				if(!$('#paytype').val()){
					App_gmuMsg('请选择支付方式！');
					return false;
				}
                if($('#ishavebd').val()==1 && $('#ishavepj').val() ==1){
                    App_gmuMsg('不能同时购买两个专区的商品！');
                    return false;
                }

				var okfun=function(){$('#orderform').submit();}
				//alert($('#djqid').val());
				if($('#djqid').val()==0){
					//App_gmuAlert('确认？','确认现在生成订单并付款吗？',false,okfun);
					okfun();
				}else{					
					//App_gmuAlert('确认？','您选择使用代金卷，生成订单后此代金卷将立刻作废，不可再次使用！确认现在生成订单并付款吗？',false,okfun);
					okfun();
				}
				
			});
			//代金卷特效
			var totalprice=$('.totalprice');
			var djqops=document.getElementById("djqid");
			djqops.addEventListener('change',function(){
				var newmoney=Number(nowtotal)-Number(djqops.options[djqops.selectedIndex].getAttribute('data-money')) - gwq - cashq - apple - mf;
				//代金券
				djq = Number(djqops.options[djqops.selectedIndex].getAttribute('data-money'));
				// 初始支付限制
				$('.ads_pay').data('disable',0);
				$('.ads_pay span').css('color',' #cfcfcf');
				// 判断当前的是否小于0，小于0设置为0
				if(newmoney<=0){
					newmoney=0;
					$('.ads_pay').each(function(){
						// 允许只允许使用余额支付
						if($(this).data('paytype')=='wxpay'){
							$(this).data('disable',1);
						}
					});
				}
				// 判断可否使用余额支付
				var money = Number($('#money').data('money'));
				if(newmoney>money){
					$('.ads_pay').each(function(){
						if($(this).data('paytype')=='money'){
							$(this).data('disable',1);
						}
					});
				}
				$(totalprice).html(newmoney);
			});

            //金果特效
            var totalprice=$('.totalprice');
            var jgops=document.getElementById("jgid");
            jgops.addEventListener('change',function(){
                var newmoney=Number(nowtotal)-Number(jgops.options[jgops.selectedIndex].getAttribute('data-money')) - gwq - cashq - djq - mf;
                apple = Number(jgops.options[jgops.selectedIndex].getAttribute('data-money'));
                // 初始支付限制
                $('.ads_pay').data('disable',0);
                $('.ads_pay span').css('color',' #cfcfcf');
                // 判断当前的是否小于0，小于0设置为0
                if(newmoney<=0){
                    newmoney=0;
                    $('.ads_pay').each(function(){
                        // 允许只允许使用余额支付
                        if($(this).data('paytype')=='wxpay'){
                            $(this).data('disable',1);
                        }
                    });
                }
                // 判断可否使用余额支付
                var money = Number($('#money').data('money'));
                if(newmoney>money){
                    $('.ads_pay').each(function(){
                        if($(this).data('paytype')=='money'){
                            $(this).data('disable',1);
                        }
                    });
                }
                $(totalprice).html(newmoney);

            });

		</script>
		<!--通用分享-->
		<!--<include file="./Tpl/App/Shop_share.html" />-->
	</body>
</html>